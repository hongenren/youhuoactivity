<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>公益上海</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" type="text/css" href="../wap/css/index.css"/>
    <link rel="stylesheet" type="text/css" href="../wap/css/cc_dh_o.css"/>
    <link rel="stylesheet" type="text/css" href="../wap/css/honeySwitch.css"/>
    <script type="text/javascript" src="../wap/js/jquery.js"></script>
    <script type="text/javascript" src="../wap/js/config.js"></script>
    <script type="text/javascript" src="../wap/js/jquery.spinner.js"></script>
    <script type="text/javascript" src="../wap/js/honeySwitch.js"></script>
    <style type="text/css">
        .int1{
            border-color: rgb(100, 189, 99)!important; box-shadow: rgb(100, 189, 99) 0px 0px 0px 16px inset!important; background-color: rgb(100, 189, 99)!important;
        }
    </style>
</head>
<body style="background: #F2F2F2">
<div class="warp">

    <div class="warp_sh_p">
        <div class="warp_hr">
            <div class="swiper-container">
                <div class="swiper-wrapper">
                </div>
                <!-- Add Arrows -->
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </div>

    <ul class="warp_sh_y">
       <li class="warp_sh_y_li">
            <div class="warp_sh_o">
                <ul class="warp_sh_i">

                </ul>
            </div>
            <ul class="warp_sh_u">
            </ul>
        </li>
    </ul>
    <ul class="warp_sh_u" style="padding: 0">
        <form>
            <li>
                <div class="warp_sh_u_ld">
                    <div class="warp_pws_c_sp warp_sh_u_lh">
                        <b><i>*</i>数量</b>
                        <input type="number" class="spinnerExample" name="total" />
                    </div>
                    <div class="warp_pws_c_sp">
                        <b>积分赠送</b>
                        <input type="number" class="spinnerExample" name="inIntegral"/>
                    </div>
                    <div class="warp_sh_u_lt">
                        <span>（积分剩余：<i style="font-style: normal">0</i>）</span>
                        <b>（签到后，自动发放）</b>
                    </div>
                    <div class="warp_pws_c_sp">
                        <b><i>*</i>门票积分价格</b>
                        <input type="number" class="spinnerExample" name="outIntegral"/>
                    </div>
                    <div class="warp_sh_u_lt">
                        <b>公众需支付积分，获取门票</b>
                    </div>
                </div>
                <div class="warp_pws_v">
                    <div class="warp_sh_u_ly">
                        <em></em>
                        <b>选项</b>
                    </div>
                    <div class="warp_sh_u_lg">
                        <div class="warp_sh_u_lf">
                            <h2 style="background: url(../wap/img/pws_112.png) no-repeat left center;background-size: 20px 20px">需审核</h2>
                            <div class="common-row">
                                <div class="cell-right"><span class="switch-off"></span></div>
                                <input type="hidden" name="audit" value="20" />
                            </div>
                        </div>
                        <div class="warp_sh_u_lf">
                            <h2 style="background: url(../wap/img/pws_114.png) no-repeat left center;background-size: 20px 20px">仅限本机构成员</h2>
                            <div class="common-row">
                                <div class="cell-right"><span class="switch-off"></span></div>
                                <input type="hidden" name="self" value="20" />
                            </div>
                        </div>
                    </div>

                    <ul class="warp_sh_u" style="margin: 0;padding: 0;background: none">
                        <li>
                            <div class="warp_sh_u_ld">
                                <div class="warp_sh_u_la">
                                    <div class="warp_pws_c_sp">
                                        <b>激活码门票</b>

                                    </div>
                                    <div class="warp_sh_u_lt">
                                        <b style="font-size: 14px">持此门票即可参与活动，无需注册</b>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="warp_sh_u_ld">
                                <div class="warp_sh_u_la">
                                    <div class="warp_pws_c_sp">
                                        <b>数量</b>
                                        <input type="number" class="spinnerExample" name="activation" />
                                    </div>
                                    <div class="warp_sh_u_lt">
                                        <b style="font-size: 14px">活动参与人数，支持点击或手动输入</b>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <div class="warp_sh_u_lk">
                        <b><i>*</i>说明</b>
                        <span>- 请提醒活动参与者在活动前进行签到</span>
                        <span>- 活动参与者不获取志愿服务时间</span>
                        <span>- 保险保障特指在本系统所获取的保险保障</span>
                        <input type="hidden" name="day" value="" />
                        <input type="hidden" name="sectionCode" value="" />
                        <input type="hidden" name="activityCode" value="" />
                        <input type="hidden" name="startTime" value="" />
                        <input type="hidden" name="endTime" value="" />
                    </div>
                </div>
            </li>
        </form>
    </ul>
    <div class="ht70"></div>
    <footer class="warp_pws_m_sw">
        <ul class="warp_pws_hd">
          <li>
            <input type="button" value="返回" onclick="window.history.go(-1)">
          </li>
          <li>
            <input type="button" value="设置成功" onclick="sub_form()" id="sub_button">
          </li>
        </ul>
    </footer>

</div>
<link rel="stylesheet" type="text/css" href="../wap/css/swiper.min.css"/>
<script type="text/javascript" src="../wap/js/swiper_sime.js"></script>
<script type="text/javascript" src="../wap/js/jquery.cookie.js"></script>
<script type="text/javascript" src="../wap/js/public.js"></script>
<script type="text/javascript" src="../wap/js/prjvorg/prjvorg.js"></script>

<script type="text/javascript" src="../wap/Layer.m/layer.js"></script>
<script type="text/javascript" src="../wap/js/act/act.js"></script>
<script type="text/javascript">
    $(function(){
        if(!history.state){
            pushHistory();
        }
        setTimeout(function(){
            window.addEventListener("popstate", function(e) {
                layer.open({
                    content: '公众门票未设置完成，您确定要返回吗？'
                    , btn: ['确定', '取消']
                    , yes: function (index) {
                        // return true
                        window.history.go(-1);
                        //$(location).attr('href', "./act_base_add.html");
                    }
                    , no: function (index) {
                        e.preventDefault();
                        pushHistory();
                    }
                })
            }, false);
        },500)

        function pushHistory() {
            var state = {
                title: "title",
                url: "#"
            };
            window.history.pushState(state, "title", "#");
        }
    });
    var isPageHide =false;
    window.addEventListener('pageshow', function(){
        if (isPageHide) {
            window.location.reload();
        }
    });
    window.addEventListener('pagehide', function(){
        isPageHide =true;
    });
    //加载日期
    function ajax_date(){
        var date_list = '';
        var date_list = JSON.parse(localStorage.getItem('date_list'));
        var html = '';
        $.each(date_list,function(index,val){
            var thisclass = index==0?'thisclass':'';
                html +='<div style="cursor:pointer" class="swiper-slide '+thisclass+'" day="'+val.day+'">\
                        <a href="javascript:void(0)">\
							<span style="line-height: 42px;">'+val.day+'</span>\
						</a>\
                    </div>';
            });

        $('.swiper-wrapper').empty();
        $('.swiper-wrapper').html(html);

        var swiper = new Swiper('.swiper-container', {
            slidesPerView: 4,
            spaceBetween: 5,
            slidesPerGroup: 4,
            loop: false,
            loopFillGroupWithBlank: false,
            pagination: {
                el: '.swiper-pagination',
                clickable: true
            },
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev'
            }
        });
        //console.log(date_list[0]['sections']);
        $("input[name='sectionCode']").val(date_list[0]['sections'][0]['code']);
        $("input[name='activityCode']").val(date_list[0]['sections'][0]['activityCode']);
        $("input[name='day']").val(date_list[0]['sections'][0]['day']);
        $("input[name='startTime']").val(date_list[0]['sections'][0]['startTime']);
        $("input[name='endTime']").val(date_list[0]['sections'][0]['endTime']);

        ajax_sections(date_list[0]['sections'],date_list[0]['day']);
        get_this_msg(date_list[0]['sections'][0]['code']);

    }
    //加载场次
    function ajax_sections(sections,day,code=''){
            var html = '';
            var name = '';
            var index2 = '';
            $.each(sections,function(index2,val2){
                if(code==''){
                    var class1 = index2==0?'thisclass':'';

                    $("input[name='sectionCode']").val(val2['code']);
                    $("input[name='day']").val(val2['day']);
                    $("input[name='startTime']").val(val2['startTime']);
                    $("input[name='endTime']").val(val2['endTime']);
                }else{
                    if(code==val2['code']){
                        var class1 = 'thisclass';

                        $("input[name='sectionCode']").val(val2['code']);
                        $("input[name='day']").val(val2['day']);
                        $("input[name='startTime']").val(val2['startTime']);
                        $("input[name='endTime']").val(val2['endTime']);
                    }
                }

                switch(val2.type){
                    case 10:
                    var name ='全天';
                    break;
                    case 20:
                    var name ='上午场';
                    break;
                    case 30:
                    var name ='下午场';
                    break;
                    case 40:
                    var name ='晚上场';
                    break;
                }
                html += '<li style="cursor:pointer" class="'+class1+'" data-date="'+day+'" data-code="'+val2.code+'" data-startTime="'+val2.startTime+'" data-endTime="'+val2.endTime+'">\
                        <span>'+name+'</span>\
                        <i></i>\
                        </li>';
                //alert($.cookie('ticket'+val2.code));
                if(localStorage.getItem('ticket'+val2.code)==1){
                    $('#sub_button').val("已设置");
                    $('#sub_button').val("已设置");
                    $('#sub_button').css({'background-color':'#ACACAC'});
                    $('#sub_button').attr("onclick",'');
                }else{
                    $('#sub_button').val("设置完成");
                    $('#sub_button').css({'background-color':'#72B81E'});
                    $('#sub_button').attr("onclick","sub_form()");
                }

            })
            $("input[name='total']").val(0);
            $("input[name='inIntegral']").val(0);
            $("input[name='outIntegral']").val(0);
            $("input[name='audit']").val('20');
            $("input[name='self']").val('20');

            $(".switch-on").attr('style','border-color: rgb(223, 223, 223); box-shadow: rgb(223, 223, 223) 0px 0px 0px 0px inset; background-color: rgb(255, 255, 255);');
            $(".switch-on").attr('class','switch-off');
            $('.warp_sh_i').empty();
            $('.warp_sh_i').html(html);

    }
     ///查询该场次信息
    function get_this_msg(sectionCode){
        $.ajax({
            xhrFields: {
               withCredentials: true
            },
            type:'POST',
            url:base_url + 'html5/v1/public/queryBySectionCode',

            data:JSON.stringify({"sectionCode" : sectionCode}),
            headers : {'token':token},
            dataType:'json',
            contentType: "application/json;charset=utf-8",
            success:function(data){
                console.log(data);
                if(data.code==0){
                    $.each(data.data,function(index,val){
                        $("input[name='"+index+"']").val(val);
                    })
                    botton_decide_class();
                }else{
                    layer.open({
                        content: data.msg
                        ,skin: 'msg'
                        ,time: 1 //2秒后自动关闭
                    });
                    return false;
                }
            },
            error:function(){
                layer.open({
                    content: '网络错误，获取失败'
                    ,skin: 'msg'
                    ,time: 1 //2秒后自动关闭
                });
                return false;
            }
        })
    }

    //查询未设置的场次
    function find_not_set(state){
        var see = 1;
        //获取日期列表
        var date_list = JSON.parse(localStorage.getItem('date_list'));
        //console.log(date_list);
        //循环日期
        $.each(date_list,function(index,data){
            //循环场次
            $.each(data.sections,function(index2,data2){
                //判断场次是否设置
                if(localStorage.getItem('ticket'+data2.code) != 1){

                    $(".swiper-wrapper .thisclass").removeClass("thisclass");

                    $("div[day='"+data2.day+"']").addClass("thisclass");
                    //发现未设置走追加接口
                    ajax_sections(data.sections,data2.day,data2.code);
                    see = 2;
                    return false;
                }
            })
            if(see == 2){
                return false;
            }
        })
        if(see == 2){
            return false;
        }
        // //console.log(date_list[0]['sections'][0]['activityCode']);
        if(state==1){
        layer.open({
                    content: '已全部设置'
                    ,skin: 'msg'
                    ,time: 1 //1秒后自动关闭
                });
        setTimeout(function(){window.location.href ='./act_set.html?activityCode='+date_list[0]['sections'][0]['activityCode']},1000);
        }
    }
     //判断 底部按钮选择
    function botton_decide_class(){
        var cla = '';
        $('.warp_sh_u_lg input').each(function(){
            var val1 = $(this).val();
            //console.log(val1)
            var cla = val1==10?'switch-on':'switch-off';
            //console.log($(this).prev('div').html())
            if(cla=='switch-on'){
                $(this).prev('div').find('span:eq(0)').attr('class',cla).addClass('int1');
            }else{
                $(this).prev('div').find('span:eq(0)').attr('class',cla);
            }

        })
    }
</script>
<script type="text/javascript">
    ajax_date();
    find_not_set();
</script>

<script>
    $(function(){
        var cotrs = $(".swiper-wrapper div");
        cotrs.live('click',function(index,val){
            var index = $(this).index();
            var date_list = JSON.parse(localStorage.getItem('date_list'));
            $(this).addClass("thisclass").siblings().removeClass("thisclass");
            ajax_sections(date_list[index].sections,date_list[index].day);
            //活动场次code
            var sectionCode = $(".warp_sh_i .thisclass").attr("data-code");
            //console.log(sectionCode)
            get_this_msg(sectionCode)
            //活动日期
            var day = $(".warp_sh_i .thisclass").attr("data-date");
            //场次开始时间
            var startTime = $(".warp_sh_i .thisclass").attr("data-starttime");
            //场次结束时间
            var endTime = $(".warp_sh_i .thisclass").attr("data-endtime");
            //清空form 给定对应参数
            $("input[name='total']").val(0);
            $("input[name='inIntegral']").val(0);
            $("input[name='outIntegral']").val(0);
            $("input[name='audit']").val('20');
            $("input[name='self']").val('20');

            $("input[name='sectionCode']").val(sectionCode);
            $("input[name='day']").val(day);
            $("input[name='startTime']").val(startTime);
            $("input[name='endTime']").val(endTime);
            //选中状态还原
            $(".switch-on").attr('style','border-color: rgb(223, 223, 223); box-shadow: rgb(223, 223, 223) 0px 0px 0px 0px inset; background-color: rgb(255, 255, 255);');
            $(".switch-on").attr('class','switch-off');

            if(localStorage.getItem('ticket'+sectionCode) == 1){
                $('#sub_button').val("已设置");
                $('#sub_button').attr("onclick",'');
            }else{
                $('#sub_button').val("设置完成");
                $('#sub_button').attr("onclick","sub_form()");
            }
        });
    });
    $(function(){
        var cotrs = $(".warp_sh_i li");
        cotrs.live('click',function(){
            $(this).addClass("thisclass").siblings().removeClass("thisclass");

            $(this).parent().parent().next('.warp_sh_u').find('li').hide()

            $(this).parent().parent().next('.warp_sh_u').find('li').eq($(this).index()).show();
            //活动场次code
            var sectionCode = $(".warp_sh_i .thisclass").attr("data-code");
            //活动日期
            var day = $(".warp_sh_i .thisclass").attr("data-date");
            //场次开始时间
            var startTime = $(".warp_sh_i .thisclass").attr("data-starttime");
            //场次结束时间
            var endTime = $(".warp_sh_i .thisclass").attr("data-endtime");

            //清空form 给定对应参数
            $("input[name='total']").val(0);
            $("input[name='inIntegral']").val(0);
            $("input[name='outIntegral']").val(0);
            $("input[name='audit']").val('20');
            $("input[name='self']").val('20');
            get_this_msg(sectionCode);
            $("input[name='sectionCode']").val(sectionCode);
            $("input[name='day']").val(day);
            $("input[name='startTime']").val(startTime);
            $("input[name='endTime']").val(endTime);

            $(".switch-on").attr('style','border-color: rgb(223, 223, 223); box-shadow: rgb(223, 223, 223) 0px 0px 0px 0px inset; background-color: rgb(255, 255, 255);');
            $(".switch-on").attr('class','switch-off');
            if(localStorage.getItem('ticket'+sectionCode) == 1){
                $('#sub_button').val("已设置");
                $('#sub_button').attr("onclick",'');
            }else{
                $('#sub_button').val("设置完成");
                $('#sub_button').attr("onclick","sub_form()");
            }
        });
    });

</script>
<script type="text/javascript">
    //ajax提交
    function sub_form(){

        // var user_msg = JSON.parse($.cookie('user_msg'));
        // var token = $.cookie('token');
        // console.log(token);
        var a = $('form').serializeArray();
        var d = {};

        $.each(a, function(){
            d[this.name] = this.value;
        });

        d['orgCode'] = prjvorgMsg.orgThirdAccount;
        d['activation'] = parseInt(d['activation']);
        d['audit'] = parseInt(d['audit']);
        d['self'] = parseInt(d['self']);
        d['inIntegral'] = parseInt(d['inIntegral']);
        d['total'] = parseInt(d['total']);
        d['user'] = prjvorgMsg.prjvUserId;
        d['name'] = actMsg.name;
        d['address'] = actMsg.address;
        d['application'] = '公益上海';
        d['contactPhone'] = actMsg.contactPhone;
        d['coverImg'] = actMsg.coverImg;
        d['sourceCode'] = '';
        d['sourceType'] = 10;
        localStorage.setItem('ticket_'+$_GET['activityCode'],parseInt(d['total']));
        //console.log(JSON.stringify(d));

        $.ajax({
            type:"post",
            url:base_url + "html5/v1/public/save",
            data:JSON.stringify(d),
            headers : {'token':token},
            dataType:'json',
            contentType: "application/json;charset=utf-8",
            beforeSend:function(){
                layer.open({type: 2,content: '提交中'});
            },
            success:function(data){
                console.log(data)
                //如果提交成功
                if(data.code==0){
                    localStorage.setItem('ticket'+d['sectionCode'],1);
                    layer.open({
                        content: '设置成功'
                        ,skin: 'msg'
                        ,time: 1 //2秒后自动关闭
                    });
                    scrollTo(0,0);
                    layer.closeAll();
                    find_not_set(1);
                }else{

                    layer.open({
                        content: data.msg
                        ,skin: 'msg'
                        ,time: 1 //2秒后自动关闭
                    });
                    setTimeout(function(){layer.closeAll();},1000);
                    return false;
                }
            },
            error:function(e){
                layer.open({
                    content: '设置失败'
                    ,skin: 'msg'
                    ,time: 1 //2秒后自动关闭
                });
                setTimeout(function(){layer.closeAll();},1000);
                return false;
            }
        })

        //查询下一个未设置场次的信息
        //find_not_set()
    }

</script>
<script type="text/javascript">
    $('.cell-right').click(function(){
        var tre = $(this).find('span').hasClass('switch-on');
        var type = tre?10:20;
        $(this).next('input').val(type);
    })

</script>
<script type="text/javascript">
    $('.spinnerExample').spinner({});
</script>
</body>
</html>

