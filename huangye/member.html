<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>公益上海</title>
    <meta name="Keywords" content="公益上海" />
    <meta name="description" content="公益上海" />
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <meta content="telephone=no, address=no" name="format-detection">
    <meta name="apple-mobile-web-app-capable" content="no" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script type="text/javascript" src="js/offset.js"></script>
    <link rel="stylesheet" href="css/mobile.css"/>
    <link rel="stylesheet" href="css/layer.css"/>
</head>
<body>
<div class="resourcesWrap">
    <div class="map_head">
        <div class="mapHead_but" onclick="javascript:history.back(-1);"></div>
        成员管理
    </div>
    <div class="memberSearchWrap clearfix">
        <div class="memberSearchLeft" style="width: 100%; border-radius: 0px;background: none;border: 1px solid #E6E6E6;">
            <input class="memberSearchVal" type="text" placeholder="请输入姓名或手机号" style="padding-right: 0px;width: 85%;">
            <div class="memberSearchIcon memberSearchBut" style="float:right;height:100%;width:15%;border: 0px;background: #72B81E;position:static;
            background-image: url(../wap/img/pws_999.png);background-repeat: no-repeat;background-position: 50% 50%;background-size: auto 20px;"></div>
        </div>
    </div>
    <div class="memberTabWrap" >
        <div class="memberTabList on" style="width: 33%;border-right: 1px solid #e5e5e5;padding: 0px;"><a href="javascript:void(0)">管理成员</a></div>
        <div class="memberTabList" style="width: 33%;border-right: 1px solid #e5e5e5;padding: 0px;"><a href="javascript:void(0)">审核成员</a></div>
        <div class="memberTabList" style="width: 33%;padding: 0px;"><a href="javascript:void(0)">下属团队成员</a></div>
    </div>
    <div class="memberBoxWrap"></div>
    <!--<div class="memberUsers clearfix">-->
        <!--<div class="memberUsersWrap">-->
            <!--<div class="memberUsersLeft">-->
                <!--<i style="background-image:url('images/wall.jpg')"></i>-->
            <!--</div>-->
            <!--<div class="memberUserRight">-->
                <!--<div class="memberUserName">-->
                    <!--<h2>张三</h2>-->
                    <!--<div class="memberUserBut">查看个人主页 <i></i></div>-->
                <!--</div>-->
                <!--<div class="memberUserLabelWrap">-->
                    <!--<div class="memberUserLabel">活动标签</div>-->
                    <!--<div class="memberUserLabel">活动标签</div>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
        <!--<div class="memberButWrap">-->
            <!--<ul>-->
                <!--<li>打标签</li>-->
                <!--<li>开除</li>-->
                <!--<li>联系</li>-->
                <!--<li>发消息</li>-->
            <!--</ul>-->
        <!--</div>-->
    <!--</div>-->
    <!--<div class="memberUsers clearfix">-->
        <!--<div class="memberUsersWrap">-->
            <!--<div class="memberUsersLeft">-->
                <!--<i style="background-image:url('images/wall.jpg')"></i>-->
            <!--</div>-->
            <!--<div class="memberUserRight">-->
                <!--<div class="memberUserName">-->
                    <!--<h2>张三</h2>-->
                    <!--<div class="memberUserBut">查看个人主页 <i></i></div>-->
                <!--</div>-->
                <!--&lt;!&ndash;<div class="memberUserLabelWrap">&ndash;&gt;-->
                <!--&lt;!&ndash;<div class="memberUserLabel">活动标签</div>&ndash;&gt;-->
                <!--&lt;!&ndash;<div class="memberUserLabel">活动标签</div>&ndash;&gt;-->
                <!--&lt;!&ndash;</div>&ndash;&gt;-->
            <!--</div>-->
        <!--</div>-->
        <!--<div class="memberButWrap">-->
            <!--<ul>-->
                <!--<li>打标签</li>-->
                <!--<li>开除</li>-->
                <!--<li>联系</li>-->
                <!--<li>发消息</li>-->
            <!--</ul>-->
        <!--</div>-->
    <!--</div>-->
    <div class="loadings" style="width:100%;height:50px;background:#fff url('images/loadings.gif') no-repeat center;background-size:auto 80%;display:none"></div>
    <div class="lastext" style="text-align:center;line-height:50px;color:#666;display:none">没有更多了</div>
</div>
<div class="memberFixedWrap">
    <div class="memberFixedTitle">描述标签</div>
    <div class="memberFixedListWrap">
        <div class="memberFixedListTxt">
            系统描述标签
        </div>
        <div class="memberFixedList">
            <ul><!--
                <li class="on">5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>-->
            </ul>
        </div>
        <div class="memberFixedListTxt">
            系统描述标签
        </div>
        <div class="memberFixedList">
            <ul><!--
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>-->
            </ul>
        </div>
    </div>
    <div class="memberFixedTitle">描述标签</div>
    <div class="memberFixedListWrap">
        <div class="memberFixedListTxt">
            <!--系统描述标签-->
        </div>
        <div class="memberFixedList">
            <ul><!--
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>
                <li>5A级景区<i></i></li>-->
            </ul>
        </div>
    </div>
    <div class="memberFixedSubmit">
        <button>确定</button>
    </div>
    <div class="memberFixedClose"></div>
</div>
<script src="js/jquery-1.11.1.min.js"></script>
<script src="js/jquery.cookie.js"></script>
<script src="js/mobileBase.js"></script>
<script src="js/config.js"></script>
<script src="js/public.js"></script>
<script src="js/layer.js"></script>
<script src="js/prjvorg.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script>
    //管理成员
    function get_ForVerify(obj,clear=true){
        var arr = {
            "prjvOrgId": obj.prjvOrgId,
            "searchContent": obj.searchContent,
            "pageSize": obj.pageSize||20,
            "pageNumber": obj.pageNumber||1
        };
        $(".memberTabList").removeClass('on').eq(0).addClass('on');
        $.ajax({
            xhrFields: {
                withCredentials: true
            },
            type:'post',
            url:base_url + "queryMembersForVerify",
            data:JSON.stringify(arr),
            dataType:'json',
            headers: {'Content-Type': 'application/json', 'token': getCookie("token")},
            beforeSend:function(XMLHttpRequest){

            },
            success:function(data){
                var datas=data.data;
                if(datas){
                    if(clear){
                        $(".memberBoxWrap").empty();
                    }
                    // $(".memberBoxWrap").empty();
                    var records=datas.records;
                    if(records.length>0){
                        for(var i=0;i<records.length;i++){
                            var realName=records[i].realName;
                            var headUrl=records[i].headUrl?records[i].headUrl:'../wap/img/pws_244.png';
                            var verifyUser=records[i].verifyUser?records[i].verifyUser:'';
                            var mobile=records[i].mobile?records[i].mobile:'';
                            var verifyUserList='';
                            if(verifyUser){
                                var verifyUserAll=verifyUser.split(',');
                                for(var j in verifyUserAll){
                                    verifyUserList+='<div class="memberUserLabel">'+verifyUserAll[j]+'</div>\n'
                                }
                            }


                            var list='<div class="memberUsers clearfix">\n' +
                                '        <div class="memberUsersWrap">\n' +
                                '            <div class="memberUsersLeft">\n' +
                                '                <i style="background-image:url(\''+headUrl+'?x-oss-process=image/crop,x_0,y_0\')"></i>\n' +
                                '            </div>\n' +
                                '            <div class="memberUserRight">\n' +
                                '                <div class="memberUserName">\n' +
                                '                    <h2>'+realName+'</h2>\n' +
                                '                    <!--<div class="memberUserBut">查看个人主页 <i></i></div>-->\n' +
                                '                </div>\n' +
                                '                <div class="memberUserLabelWrap">\n' +
                                verifyUserList+
                                '                </div>\n' +
                                '            </div>\n' +
                                '        </div>\n' +
                                '        <div class="memberButWrap">\n' +
                                '            <ul>\n' +
                                '                <li onclick="exceptOrgMember(\''+records[i].personThirdAccount+'\')">开除</li>\n' +
                                '                <li><a href="tel:'+mobile+'">联系</a></li>\n' +
                                // '                <li>发消息</li>\n' +
                                '            </ul>\n' +
                                '        </div>\n' +
                                '    </div>'
                            $(".memberBoxWrap").append(list);
                        }
                    }else {
                        if($(".memberUsers.tog").length>0){
                            $(".memberUsers.tog").remove();
                        }
                        $(".memberBoxWrap").append('<div class="memberUsers tog clearfix" style="padding: 0px;margin-top: .2rem;">\n' +
                            '        <div class="memberUsersWrap" style="padding: 0px;border: 0px;padding-left: 10px;">\n' +
                            '            <div class="memberUserRight">\n' +
                            '                <div class="memberUserName">\n' +
                            '                    <h2>暂无数据</h2>\n' +
                            '                </div>\n' +
                            '            </div>\n' +
                            '        </div>\n' +
                            '    </div>');
                        // layer.open({
                        //     content: '暂无数据'
                        //     ,skin: 'msg'
                        //     ,time: 1 //2秒后自动关闭
                        // });
                    }


                }
            },
            error:function(){
                layer.open({
                    content: '获取失败'
                    ,skin: 'msg'
                    ,time: 1 //2秒后自动关闭
                });
                return false;
            }

        })
    }
    function exceptOrgMember(personThirdAccount){
        layer.open({
            content: '确定要开除该名成员吗？'
            , btn: ['确定', '取消']
            , yes: function (index) {
                $.ajax({
                    xhrFields: {
                        withCredentials: true
                    },
                    type:'post',
                    url:base_url + "exceptOrgMember",
                    data: "{\"personThirdAccount\": \"" + personThirdAccount + "\"}",
                    dataType:'json',
                    headers: {'Content-Type': 'application/json', 'token': getCookie("token")},
                    beforeSend:function(XMLHttpRequest){

                    },
                    success:function(data){
                        var datas=data;
                        if(datas){
                            if(datas.msg=='success'){
                                layer.open({
                                    content: '操作成功'
                                    ,skin: 'msg'
                                    ,time: 1 //2秒后自动关闭
                                });
                                refresh();
                                return false;
                            }else {
                                layer.open({
                                    content: '操作失败'
                                    ,skin: 'msg'
                                    ,time: 1 //2秒后自动关闭
                                });
                                return false;
                            }
                        }
                    },
                    error:function(){
                        layer.open({
                            content: '请求失败'
                            ,skin: 'msg'
                            ,time: 1 //2秒后自动关闭
                        });
                        return false;
                    }

                })
            }
        });
    }
    //拒绝和通过
    function verifyOrgMember(ver,elm){
        if(ver){
            var token=getCookie("token");
            $.ajax({
                xhrFields: {
                    withCredentials: true
                },
                type:'post',
                url:base_url + "verifyOrgMember",
                data:JSON.stringify(ver),
                dataType:'json',
                headers: {'Content-Type': 'application/json', 'token': getCookie("token")},
                beforeSend:function(XMLHttpRequest){

                },
                success:function(data){
                    var datas=data;
                    if(datas){
                        if(datas.msg=='success'){
                            layer.open({
                                content: '操作成功'
                                ,skin: 'msg'
                                ,time: 1 //2秒后自动关闭
                            });

                            refresh();
                            return false;
                        }else {
                            layer.open({
                                content: '操作失败'
                                ,skin: 'msg'
                                ,time: 1 //2秒后自动关闭
                            });
                            return false;
                        }
                    }
                },
                error:function(){
                    layer.open({
                        content: '请求失败'
                        ,skin: 'msg'
                        ,time: 1 //2秒后自动关闭
                    });
                    return false;
                }

            })
        }

    }

    //待审核成员
    function get_ForWaitVerify(obj,clear=true){
        var arr = {
            "prjvOrgId": obj.prjvOrgId,
            "searchContent": obj.searchContent,
            "pageSize": obj.pageSize||20,
            "pageNumber": obj.pageNumber||1
        };
        $(".memberTabList").removeClass('on').eq(1).addClass('on');
        $.ajax({
            xhrFields: {
                withCredentials: true
            },
            type:'post',
            url:base_url + "queryMembersForWaitVerify",
            data:JSON.stringify(arr),
            dataType:'json',
            headers: {'Content-Type': 'application/json', 'token': getCookie("token")},
            beforeSend:function(XMLHttpRequest){
                $(".loadings").show();
                $(".lastext").hide();
            },
            success:function(data){
                var datas=data.data;
                if(datas){
                    if(clear){
                        $(".memberBoxWrap").empty();
                    }
                    var records=datas.records;
                    if(records.length>0){
                        for(var i=0;i<records.length;i++){
                            var realName=records[i].realName;
                            var headUrl=records[i].headUrl?records[i].headUrl:'../wap/img/pws_244.png';
                            var verifyUser=records[i].verifyUser?records[i].verifyUser:'';
                            var prjvUserIds=records[i].prjvUserId?records[i].prjvUserId:'';
                            var ids=records[i].id?records[i].id:'';
                            var mobile=records[i].mobile?records[i].mobile:'';
                            var verifyUserList='';
                            if(verifyUser){
                                var verifyUserAll=verifyUser.split(',');
                                for(var j in verifyUserAll){
                                    verifyUserList+='<div class="memberUserLabel">'+verifyUserAll[j]+'</div>\n'
                                }
                            }
                            var verifyOrg1={
                                id:ids,
                                prjvUserId:prjvUserIds,
                                state:20
                            }
                            var verifyOrg2={
                                id:ids,
                                prjvUserId:prjvUserIds,
                                state:-10
                            }



                            var list='<div class="memberUsers clearfix">\n' +
                                '        <div class="memberUsersWrap">\n' +
                                '            <div class="memberUsersLeft">\n' +
                                '                <i style="background-image:url(\''+headUrl+'?x-oss-process=image/crop,x_0,y_0\')"></i>\n' +
                                '            </div>\n' +
                                '            <div class="memberUserRight">\n' +
                                '                <div class="memberUserName">\n' +
                                '                    <h2>'+realName+'</h2>\n' +
                                '                    <!--<div class="memberUserBut">查看个人主页 <i></i></div>-->\n' +
                                '                </div>\n' +
                                '                <div class="memberUserLabelWrap">\n' +
                                verifyUserList+
                                '                </div>\n' +
                                '            </div>\n' +
                                '        </div>\n' +
                                '        <div class="memberButWrap">\n' +
                                '            <ul>\n' +
                                '                <li><a  href="tel:'+mobile+'">联系</a></li>\n' +
                                '                <li onclick=\'verifyOrgMember('+JSON.stringify(verifyOrg1)+',this)\'>通过</li>\n' +
                                '                <li onclick=\'verifyOrgMember('+JSON.stringify(verifyOrg2)+',this)\'>拒绝</li>\n' +
                                '            </ul>\n' +
                                '        </div>\n' +
                                '    </div>'
                            $(".memberBoxWrap").append(list);
                        }
                    }else {
                        $(".memberBoxWrap").append('<div class="memberUsers clearfix" style="padding: 0px;margin-top: .2rem;">\n' +
                            '        <div class="memberUsersWrap" style="padding: 0px;border: 0px;padding-left: 10px;">\n' +
                            '            <div class="memberUserRight">\n' +
                            '                <div class="memberUserName">\n' +
                            '                    <h2>暂无数据</h2>\n' +
                            '                </div>\n' +
                            '            </div>\n' +
                            '        </div>\n' +
                            '    </div>');
                        layer.open({
                            content: '暂无数据'
                            ,skin: 'msg'
                            ,time: 1 //2秒后自动关闭
                        });
                    }


                }
            },
            error:function(){
                layer.open({
                    content: '获取失败'
                    ,skin: 'msg'
                    ,time: 1 //2秒后自动关闭
                });
                return false;
            },
            complete:function(){
                $(".loadings").hide();
                $(".lastext").show();
            }

        })
    }

    var obj//管理成员参数
        ,obj2;//待审核成员参数
    window.onload=function(){
        var prjvOrgId = $.getUrlParam("prjvOrgId");
        obj={
            "prjvOrgId": prjvOrgId,
            "searchContent": '',
            "pageSize": 20,
            "pageNumber": 1
        };
        obj2={
            "prjvOrgId": prjvOrgId,
            "searchContent": '',
            "pageSize": 20,
            "pageNumber": 1
        };
        var nowIndex='';

        //管理成员和待审核成员tab切换
        $(".memberTabList").click(function(){
            $(this).addClass('on').siblings('.memberTabList').removeClass('on');
            var objVal=$(".memberSearchVal").val();
            if($(this).index()==0){
                obj['pageNumber']=1;
                obj['searchContent']=objVal||'';
                get_ForVerify(obj,true);//管理成员
            }
            if($(this).index()==1){
                obj2['pageNumber']=1;
                obj2['searchContent']=objVal||'';
                get_ForWaitVerify(obj2,true) //审核成员
            }
            if($(this).index()==2){
                querySubOrgCountByParentAccount();
            }
        });

        //搜索点击事件
        $(".memberSearchBut").click(function(){
            $(".memberTabList").each(function(){
                if($(this).hasClass('on')){
                    nowIndex=$(this).index();
                }
            });
            var objVal=$(".memberSearchVal").val();
            if(objVal==''){
                layer.open({
                    content: '请填写搜索关键字'
                    ,skin: 'msg'
                    ,time: 1 //2秒后自动关闭
                });
            }
            // obj.searchContent=obj2.searchContent=objVal;
            if(nowIndex==0){
                obj['pageNumber']=1;
                obj['searchContent']=objVal||'';
                get_ForVerify(obj);//管理成员
            }
            if(nowIndex==1){
                obj2['pageNumber']=1;
                obj2['searchContent']=objVal||'';
                get_ForWaitVerify(obj2) //审核成员
            }
            if(nowIndex==2){
                querySubOrgCountByParentAccount();
            }

        });
        get_ForVerify(obj);//管理成员
        // get_ForWaitVerify(obj2) //审核成员

        //滚动事件
        var t=0;
        var p=0;
        $(window).scroll(function(e){
            t=$(this).scrollTop();
            var doc=$(document).height();
            var win=$(window).height();
            console.log('doc-'+doc,' win-'+win)
            if(p<=t){//console.log("向下");
                if(t>doc-(win+100)){

                    if($(document).height() - $(window).height() - $(window).scrollTop()<5){
                        //添加数据
                        $(".memberTabList").each(function(){
                            if($(this).hasClass('on')){
                                nowIndex=$(this).index();
                            }
                        });
                        var objVal=$(".memberSearchVal").val();
                        var len=$(".memberBoxWrap").find('.memberUsers').length;
                        if(nowIndex==0){
                            var num=parseInt(obj['pageNumber']);
                            if(len>=20*num){
                                $(".loadings").show();
                                $(".lastext").hide();
                                obj['pageNumber']=parseInt(obj['pageNumber'])+1;
                                obj['searchContent']=objVal||'';
                                get_ForVerify(obj,false);//管理成员
                            }else {
                                $(".loadings").hide();
                                $(".lastext").show();
                            }
                        }
                        if(nowIndex==1){
                            var num=parseInt(obj2['pageNumber']);
                            if(len>=20*num){
                                $(".loadings").show();
                                $(".lastext").hide();
                                obj2['pageNumber']=parseInt(obj2['pageNumber'])+1;
                                obj2['searchContent']=objVal||'';
                                get_ForWaitVerify(obj2,false) //审核成员
                            }else {
                                $(".lastext").show();
                                $(".loadings").hide();
                            }
                        }
                    }
                }else{
                    $(".loadings").hide();
                    $(".lastext").show();
                }

            }else{//console.log("向上")
            }
            setTimeout(function(){p=t},0)
        });
    };

    //刷新
    function refresh(){
        var refIndex='';
        $(".memberTabList").each(function(){
            if($(this).hasClass('on')){
                refIndex=$(this).index();
            }
        });
        var objVal=$(".memberSearchVal").val();
        obj.searchContent=obj2.searchContent=objVal;
        if(refIndex==0){
            get_ForVerify(obj);//管理成员
        }
        if(refIndex==1){
            get_ForWaitVerify(obj2) //审核成员
        }
        if(refIndex==2){
            querySubOrgCountByParentAccount();//下属团队成员
        }
    }

    //下属团队成员
    function querySubOrgCountByParentAccount() {
        $(".memberTabList").removeClass('on').eq(2).addClass('on');
        var objVal=$(".memberSearchVal").val();
        $.ajax({
            xhrFields: {
                withCredentials: true
            },
            type: 'post',
            url: base_url1 + "/html5/v1/orgPlace/querySubOrgCountByParentAccount",
            data:JSON.stringify({"parentOrgThirdAccount":prjvorgMsg.orgThirdAccount,"searchContent":objVal||""}),
            dataType: 'json',
            headers: {'Content-Type': 'application/json', 'token': getCookie("token")},
            beforeSend: function (XMLHttpRequest) {

            },
            success: function (data) {
                if (data.code==0) {
                    var data_list = data.data.records;
                    var html = "";
                    if(data_list!=''){
                        $.each(data_list,function(index,val){
                            html += "<li class='clearfix' style='margin:0px;border-bottom:1px solid #e5e5e5;min-height: 55px;list-style: none;background-color: #ffffff;' onclick='jump(\"./memberSubOrg.html?prjvOrgId="+val.prjvOrgId+"\")'>" +
                                            "<span style='display:inline-block;max-width:70%;padding: 16px 0;padding-left: 10px;line-height: 24px;'>"+val.name+"</span>" +
                                "<span style='padding-right:10px;height: 55px;width:55px;float: right;background: url(../wap/img/pws_54.png) no-repeat center;'></span>"+
                                            "<span style='padding-right:10px;line-height: 55px;float: right;'>"+val.memberCount+"人</span>"+
                                    "</li>";
                        })
                    }else{
                        layer.open({
                            content: '暂无数据'
                            ,skin: 'msg'
                            ,time: 1 //2秒后自动关闭
                        });
                    }
                    $(".memberBoxWrap").html(html);
                }
            }
        })
    }
</script>
</body>
</html>
